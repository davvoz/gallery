<!DOCTYPE html>
<html lang="en">

<head>
  <title>My Image Gallery</title>
  <link rel="stylesheet" href="style.css">
</head>

<body>
  <div id="all-container">
    <div class="modal-fade" id="modal" role="dialog">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <button id="prev-button" style="z-index: 999999;" class="soloDesktop">&lt;</button>
            <button id="next-button" style="z-index: 999999;" class="soloDesktop">&gt;</button>
          </div>
          <div class="modal-body">
            <div class="modal-img-container">
              <img src="" alt="modal image" id="modal-image">
            </div>
            <div class="modal-text-container" id="modal-text-container">
              <h2 id="modal-h4">Modal Title</h2>
              <p id="modal-desc">Modal Description</p>
            </div>
          </div>
          <div class="modal-footer">
          </div>
        </div>
      </div>
    </div>
    <div id="toolbar">
      <h1>
        My Gallery App <span id="counter"></span>
        <a href="https://twitter.com/GiolliLucio">twitter</a>
        <a href="https://opensea.io/Luciogiolli">opensea</a>
      </h1>
      

    </div>
    <div id="image-container">
    </div>
  </div>
  <script src="https://www.gstatic.com/firebasejs/7.14.4/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/7.14.4/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/7.14.4/firebase-storage.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyB8m3IyfgaH7_S3f0z_8j7Nf-ryoL5H3_g",
      authDomain: "wada-42dd4.firebaseapp.com",
      databaseURL: "https://wada-42dd4.firebaseio.com",
      projectId: "wada-42dd4",
      storageBucket: "wada-42dd4.appspot.com",
      messagingSenderId: "87083060977",
      appId: "1:87083060977:web:a525a46e147b0f0e7a2350"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    // Incrementa il valore della proprietà "valore" della document "galleria" di 1
    db.collection("progressivi").doc("galleria").update({
      valore: firebase.firestore.FieldValue.increment(1)
    });
    let previewOpen = false;

    let currentIndex = 0;
    document.getElementById('next-button').addEventListener('click', nextImage);
    document.getElementById('prev-button').addEventListener('click', precImage);
    //senti quando fanno lo swipe 
    document.getElementById('modal-image').addEventListener('touchstart', handleTouchStart, false);
    document.getElementById('modal-image').addEventListener('touchmove', handleTouchMove, false);
    //recupera il valore della proprietà "valore" della document "galleria" e lo assegna alla variabile val
    let val = 0;
    db.collection("progressivi").doc("galleria").get().then((doc) => {
      val = doc.data().valore;
      document.getElementById('counter').innerHTML = val;
    });

    let xDown = null;
    let yDown = null;
    let listaPreviews = [];

    const modalFade = document.querySelector('.modal-fade');

    modalFade.addEventListener('click', (event) => {
      if (event.target === modalFade) {
        modalFade.style.display = 'none';
      }
    });
    
    function getTouches(evt) {
      return evt.touches || // browser API
        evt.originalEvent.touches; // jQuery
    }

    function handleTouchStart(evt) {
      const firstTouch = getTouches(evt)[0];
      xDown = firstTouch.clientX;
      yDown = firstTouch.clientY;
    };

    function handleTouchMove(evt) {
      if (!xDown || !yDown) {
        return;
      }

      var xUp = evt.touches[0].clientX;
      var yUp = evt.touches[0].clientY;

      var xDiff = xDown - xUp;
      var yDiff = yDown - yUp;

      if (Math.abs(xDiff) > Math.abs(yDiff)) { /*most significant*/
        if (xDiff > 0) {
          /* left swipe */
          nextImage();
        } else {
          /* right swipe */
          precImage();
        }
      } else {
        if (yDiff > 0) {
          /* up swipe */
        } else {
          /* down swipe */
        }
      }
      /* reset values */
      xDown = null;
      yDown = null;
    };


    class MyImage {
      constructor(url, titolo, descrizione, id) {
        this.url = url;
        this.titolo = titolo;
        this.descrizione = descrizione;
        this.id = id;
      }
    }
    class ImageList {
      constructor() {
        this.images = [];
      }

      addImage(image) {
        this.images.push(image);
      }

      getImages() {
        return this.images;
      }
    }
    class ImageService {
      async getImageList() {
        const imageList = new ImageList();
        const imagesCollection = db.collection('images');
        const images = await imagesCollection.get();
        images.forEach(image => {
          const url = image.data().url;
          const titolo = image.data().titolo;
          const descrizione = image.data().descrizione;
          const id = image.id;
          imageList.addImage(new MyImage(url, titolo, descrizione, id));
        });
        return imageList;
      }
    }
    class ImageServiceController {
      constructor() {
        this.imageService = new ImageService();
      }

      async getImageList() {
        return this.imageService.getImageList();
      }
    }


    function createImageElement(image) {
      // Create the image element
      const imgElement = document.createElement('img');
      imgElement.src = image.url;
      imgElement.alt = image.titolo;
      imgElement.title = image.titolo;

      imgElement.classList.add('image');
      // Create the image container

      const imgContainer = document.createElement('div');
      imgContainer.classList.add('image-container');
      //quando clicco l'immagine mi apre il modal
      imgElement.addEventListener('click', () => {
        document.getElementById('modal-image').src = image.url;
        document.getElementById('modal-desc').innerText = image.descrizione ;
        document.getElementById('modal-h4').innerText = image.titolo;

        // Show the modal
        document.getElementById('modal').style.display = 'block';
        //fai un update dell'immagine aumenta la nuova proprietà clikcs
        db.collection("images").doc(image.id).update({
          clicks: firebase.firestore.FieldValue.increment(1)
        });


      });
      // Append the image, title and description to the image container
      imgContainer.appendChild(imgElement);
      //imgContainer.appendChild(titleElement);
      return imgContainer;
    }
    async function displayImages() {
      const imageServiceController = new ImageServiceController();
      const imageList = await imageServiceController.getImageList();
      document.getElementById('image-container').innerHTML = '';
      imageList.getImages().forEach(image => {
        const imgElement = createImageElement(image);
        document.getElementById('image-container').appendChild(imgElement);
        previewOpen = true;
        listaPreviews.push(image);
      });
    }
    function sistema() {
      document.getElementById('modal-edit-form').style.display = 'none';
      document.getElementById('modal-text-container').style.display = 'block';

    }
    function nextImage() {
      currentIndex++;
      if (currentIndex >= listaPreviews.length) {
        currentIndex = 0;
      }
      showModal(currentIndex);
    }
    function precImage() {
      currentIndex--;
      if (currentIndex < 0) {
        currentIndex = listaPreviews.length - 1;
      }
      showModal(currentIndex);
    }
    function showModal(index) {
      document.getElementById('modal-image').src = listaPreviews[index].url;
      document.getElementById('modal-desc').innerText = listaPreviews[index].descrizione ;
      document.getElementById('modal-h4').innerText = listaPreviews[index].titolo;
      document.getElementById('modal').style.display = 'block';
      //aumenta la nuova proprietà clikcs
      // db.collection("images").doc(listaPreviews[index].id).update({
      //   clicks: firebase.firestore.FieldValue.increment(1)
      // });

    }
    displayImages();

  </script>
</body>

</html>